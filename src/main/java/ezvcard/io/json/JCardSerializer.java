package ezvcard.io.json;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import com.fasterxml.jackson.core.JsonGenerator;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.core.Version;
import com.fasterxml.jackson.databind.JsonSerializer;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.SerializerProvider;
import com.fasterxml.jackson.databind.module.SimpleModule;
import com.fasterxml.jackson.databind.ser.std.StdSerializer;

import ezvcard.VCard;

public class JCardSerializer extends StdSerializer<VCard> {
	private static final long serialVersionUID = 1L;

	/**
	 * 
	 * Configures an {@link ObjectMapper} with the abillity to serialize
	 * {@link VCard} objects into JCard format, e.g:<br/>
	 * 
	 * <pre>
	 * String vCardToJCard(VCard vcard) {
	 * 	ObjectMapper mapper = new ObjectMapper();
	 * 	JCardSerializer.configureObjectMapper(mapper, true);
	 * 	return mapper.writeValueAsString(vcard);
	 * }
	 * </pre>
	 * 
	 * @param mapper
	 *            the mapper to add the jcard serialization module to
	 * @param addProdId
	 *            whether or not to add a "PRODID" property to each vCard,
	 *            saying that the vCard was generated by this library. For 2.1
	 *            vCards, the extended property "X-PRODID" will be added, since
	 *            "PRODID" is not supported by that version
	 */
	public static void configureObjectMapper(ObjectMapper mapper, boolean addProdId) {
		List<JsonSerializer<?>> list = new ArrayList<JsonSerializer<?>>();
		list.add(new JCardSerializer(addProdId));
		mapper.registerModule(new SimpleModule("jcardserializer", Version.unknownVersion(), list));
	}

	private boolean addProdId;

	/**
	 * Creates a new JCardSerializer with default settings
	 */
	public JCardSerializer() {
		super(VCard.class);
	}

	/**
	 * Creates a new JCardSerializer with overridden settings
	 * 
	 * @param addProdId
	 *            true if the product id should be added to vcards written by
	 *            this object
	 */
	public JCardSerializer(boolean addProdId) {
		this();
		this.addProdId = addProdId;
	}

	@Override
	public void serialize(VCard value, JsonGenerator gen, SerializerProvider serializers)
			throws IOException, JsonProcessingException {
		JCardWriter writer = new JCardWriter(gen);
		writer.setAddProdId(addProdId);
		writer.write(value);
	}

}
